
---
title: "GeneSet: Representing Gene Sets in the Tidyverse"
author: "Kayla Morrell"
date: "`r Sys.Date()`"
output:
    BiocStyle::html_document
package: GeneSet
vignette: >
    %\VignetteIndexEntry{GeneSet: Representing Gene Sets in the Tidyverse}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEndcoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

# Introduction
`GeneSet` is a package that represents gene sets in a tibble format with the `GeneSet` class. Gene sets are read in and converted into a tibble format. From here, typical `dplyr` operations can be performed on the tibble gene set.

# Installation
Install the most recent version from Bioconductor:

```{r bioconductor, eval = FALSE}
if(!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("GeneSet")
```

The development version is also available for install from GitHub:

```{r github, eval = FALSE}
BiocManager::install("Kayla-Morrell/GeneSet")
```

Then load `GeneSet`:

```{r  load, message = FALSE}
library(GeneSet)
```
# GeneSet

## Input and Output

`GeneSet` can create a `GeneSet` using two different input methods. The first is to input named character vectors of gene sets. `GeneSet` returns three tibbles, `gene` which contains the genes, `set` which contains the sets and `geneset` which contains genes and sets. 

```{r constructor}
tbl <- GeneSet(set1 = letters, set2 = LETTERS)
tbl
```

The second method of creating a `GeneSet` would be to read in `.gmt` files. Using `import()`, a path to a downloaded `.gmt` file is read in and a `GeneSet` is returned. The example below uses a hallmark gene set downloaded from [GSEA][], which is also included with this package. This `GeneSet` includes a `source` column within the `geneset` tibble for reference as to where the gene set came from.

[GSEA]: http://software.broadinstitute.org/gsea/index.jsp

```{r gmt}
gmtFile <- system.file(package = "GeneSet",
                        "extdata",
                        "hallmark.gene.symbol.gmt")
tbl2 <- import(gmtFile)
tbl2
```

`export()` allows for a `GeneSet` to be exported into a temporary file with the extention `.gmt`.

```{r export, tidy = TRUE}
fl <- tempfile(fileext = ".gmt")
gmt <- export(tbl2, fl)
gmt
```

## Implemented functions

`GeneSet` adopts the use of many `dplyr` functions such as `filter()`, `select()`, `mutate()`, `group_by()`, `ungroup()`, `summarise()`, `arrange()`, `group_vars()` and `tbl_vars()`.

```{r examples}
tbl <- GeneSet(set1 = letters, set2 = LETTERS)
tbl
tbl %>% filter(gene == "a" | gene == "A")
tbl %>% mutate(pval = rnorm(1:52))
tbl %>% group_by(set,gene) %>% group_vars()
```

Another feature available to `GeneSet` is the ability to activate different tibbles. When a `GeneSet` is created, the tibble `geneset` is automatically activated and all functions will be performed on this tibble. With `gs_activate()` the user is able to pick a different tibble to activate and work on.

```{r activate}
tbl <- GeneSet(set1 = letters, set2 = LETTERS)
tbl
tbl %>% gs_activate(gene) %>% filter(gene == "a" | gene == "A")
tbl %>% gs_activate(set) %>% mutate(pval = rnorm(1:2))
tbl %>% gs_activate(gene) %>% summarise(n = n())
```

# Case study

Next, we demonstrate the use of `GeneSet` with an experiement dataset `airway` from the package `airway`. This data is from an RNA-Seq experiment on airway smooth muscle (ASM) cell lines.

The first step is to load the library and the necessary data.

```{r airway, message = FALSE}
library(airway)
data("airway")
se <- airway
```

The packages `AnnotationDbi` and `org.Hs.eg.db` are used for the mapping of gene symbols, GO ids, and Entrez ids to the already established Ensembl ids in `airway`. These Ensembl ids are the rownames of `airway`.

Represent GO identifiers as a GeneSet

Discover keys and use AnnotationDbi:select to work with org objects.
```{r}
library(org.Hs.eg.db)
go_sets <- 
    function(org = org.Hs.eg.db)
{
    map <- AnnotationDbi::select(
        org, keys(org, "ENSEMBL"), c("ENSEMBL", "GO"), "ENSEMBL"
    )
    do.call(GeneSet, split(map$ENSEMBL, map$GO))
}
```

```{r}
go <- go_sets(org.Hs.eg.db)
```

```{r}
se1 = se[rowSums(assay(se)) != 0,]
gs_activate(go, gene) %>% filter(gene %in% rownames(se1))
```

How many genes in each set?

```{r}
gs_activate(go, geneset) %>% count(set)
```

Remove empty sets?

```{r}
drop <- gs_activate(go, geneset) %>% count(set) %>% filter(n == 0) %>% pull(set)
gs_activate(go, set) %>% filter(set %in% drop)
```

Use different identifiers

```{r}
map <- mapIds(
    org.Hs.eg.db, keys(org.Hs.eg.db, "ENSEMBL"), "SYMBOL", "ENSEMBL"
)
tbl <- tibble::enframe(map, name = "ENSEMBL", value="SYMBOL")
go %>% map_gene(tbl$ENSEMBL, tbl$SYMBOL)

## gs_map_org(org.Hs.eg.db, "ENSEMBL", "SYMBOL")
```

Add information about sets, e.g., the set definition

```{r}
map <- mapIds(GO.db, as.character(gs_set(go)$set), "DEFINITION", "GOID")
gs_activate(go, "set") %>% mutate(definition = unname(map))
```

The library `KEGGREST` is a client interface to the KEGG REST server. KEGG contains pathway maps that represent interaction, reaction and relation networks for various biological processes and diseases. Below we use `KEGGREST` to develop a `tbl_geneset` that contains the genes for every pathway map in KEGG.

<!-- need to work on the sapply function, currently taking almost 3 minutes to run the keggGet for all 330 pathways. -->

<!-- need to figure out how to change set back to a factor, after left_join -->


```{r kegg, message = FALSE}
library(KEGGREST)
library(tibble)

kegg_sets <- function(species = "hsa") {
    paths <- enframe(keggList("pathway", "hsa"))
    paths <- mutate(
        name = sub("path:", "", name),
        value = gsub(" \\-.*", "", value)
    )
    genes <- lapply(paths$name, function(x) {
        path <- keggGet(x) # (n = 330) will take some time
        path[[1]]$GENE[c(TRUE, FALSE)]
    })
    genes <- genes[lengths(genes) != 0]

    do.call(GeneSet, genes)
}
```

```{r}
rname <- "kegg_hsa"
exists <- NROW(bfcquery(query=rname, field="rname")) != 0L
if (!exists)
    fl <- bfcnew(rname = rname, ext = ".gmt")
    export(kegg_sets("hsa"), fl)
}
kegg <- import(bfcrpath(rname=rname))
```

```
paths <- filter(kegg, name %in% gs_geneset(tbl)$set)
gs_set(tbl) <- gs_set(tbl) %>% left_join(paths, by = c("set" = "name"))
tbl <- gs_activate(tbl, gene) %>% 
    mutate(
        ensembl = mapIds(
            org.Hs.eg.db,
            keys = gs_gene(tbl)$gene,
            column = "ENSEMBL",
            keytype = "ENTREZID",
            multivals = "first"
        )
    )
```
Since we are working with ASM data we thought we would subset the `airway` data to contain only the genes in the asthma pathway. This filter can be done on either the KEGG id (which for asthma is "hsa05310") or the pathway name. We demonstrate using the pathway name.

```{r subset}
asthma <- tbl %>% gs_activate(set) %>% filter(value == "Asthma")

se <- se[rownames(se) %in% gs_gene(asthma)$ensembl,]

se
rowData(se)
```

Filtering can also be done for multiple pathways. 

```{r multiple}
pathways <- c("hsa05310", "hsa04110", "hsa05224", "hsa04970")
multipaths <- tbl %>% gs_activate(set) %>% filter(set %in% pathways)

multipaths
```

# Session info

```{r}
sessionInfo()
```
